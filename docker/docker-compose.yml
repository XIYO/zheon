name: zheon

services:
  tor-proxy:
    image: xiyo/tor-proxy:latest
    container_name: zheon-tor-proxy
    ports:
      - '9050:9050'
      - '8118:8118'
    environment:
      PROXY_PORT: 8118
      TOR_SOCKS_HOST: 127.0.0.1
      TOR_SOCKS_PORT: 9050
      READ_TIMEOUT: 30s
      WRITE_TIMEOUT: 30s
      CLIENT_TIMEOUT: 60s
      MAX_HEADER_BYTES: 1048576
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'nc', '-z', 'localhost', '8118']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - zheon-network

  zheon:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: zheon-app
    ports:
      - '3000:3000'
    env_file:
      - ../.env
    environment:
      ORIGIN: http://localhost:3000
      PORT: 3000
      TOR_SOCKS5_PROXY: socks5://zheon-tor-proxy:9050
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    depends_on:
      tor-proxy:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - zheon-network

networks:
  zheon-network:
    driver: bridge
