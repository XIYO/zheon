<!DOCTYPE html>
<html>
<head>
    <title>YouTube Sync Test</title>
    <script>
        // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‹¤í–‰í•  í…ŒìŠ¤íŠ¸ ì½”ë“œ
        async function testSync() {
            console.log('ğŸ” Testing YouTube sync...');

            // page.data.supabase ê°ì²´ í™•ì¸
            if (!window.page?.data?.supabase) {
                console.error('âŒ Supabase not found in page.data');
                console.log('ğŸ’¡ Run this in the browser console on /youtube/subscriptions page');
                return;
            }

            const supabase = page.data.supabase;
            console.log('âœ… Supabase client found');

            try {
                // 1. í˜„ì¬ ì„¸ì…˜ í™•ì¸
                console.log('\nğŸ“‹ Step 1: Checking session...');
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();

                if (sessionError || !session) {
                    console.error('âŒ No session found:', sessionError);
                    return;
                }

                console.log('âœ… Session found');
                console.log('- User ID:', session.user.id);
                console.log('- Email:', session.user.email);
                console.log('- Provider:', session.user.app_metadata?.provider);
                console.log('- Has provider_token?', !!session.provider_token);
                console.log('- Has provider_refresh_token?', !!session.provider_refresh_token);

                // provider_token í™•ì¸
                if (!session.provider_token) {
                    console.error('âŒ No Google OAuth token (provider_token) found!');
                    console.log('ğŸ’¡ You need to re-authenticate with Google');
                    console.log('ğŸ’¡ Try logging out and logging in again with Google');
                    return;
                }

                console.log('âœ… Google OAuth token found');

                // 2. Edge Function í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (provider_tokenì„ bodyë¡œ ì „ë‹¬)
                console.log('\nğŸ“‹ Step 2: Calling Edge Function...');

                const { data, error } = await supabase.functions.invoke(
                    'sync-youtube-subscriptions',
                    {
                        body: {
                            providerToken: session.provider_token,
                            userId: session.user.id
                        }
                    }
                );

                if (error) {
                    console.error('âŒ Edge Function error:', error);
                    console.error('- Message:', error.message);
                    console.error('- Details:', error);
                } else {
                    console.log('âœ… Edge Function success!');
                    console.log('- Response:', data);

                    if (data?.success) {
                        console.log('ğŸ“Š Sync Results:');
                        console.log('- Subscriptions found:', data.subscriptions_found);
                        console.log('- Channels synced:', data.channels_synced);
                        console.log('- API units used:', data.api_units_used);
                        console.log('- Cost per channel:', data.cost_per_channel);
                    }
                }

            } catch (error) {
                console.error('âŒ Unexpected error:', error);
            }
        }

        // ìë™ ì‹¤í–‰ ë°©ì§€
        console.log('ğŸ“Œ Test function loaded');
        console.log('Run: testSync() in console to start test');
    </script>
</head>
<body>
    <h1>YouTube Sync Test</h1>
    <p>Open browser console and run:</p>
    <pre>testSync()</pre>

    <hr>

    <h2>ë˜ëŠ” ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì§ì ‘ ì‹¤í–‰:</h2>
    <pre>
// 1. Supabase ê°ì²´ í™•ì¸
console.log('Supabase:', page.data.supabase);

// 2. ì„¸ì…˜ í™•ì¸
const { data: { session } } = await page.data.supabase.auth.getSession();
console.log('Session:', session);
console.log('Provider token:', session?.provider_token);

// 3. Edge Function í˜¸ì¶œ (provider_tokenì„ bodyë¡œ ì „ë‹¬)
const result = await page.data.supabase.functions.invoke('sync-youtube-subscriptions', {
    body: {
        providerToken: session?.provider_token,
        userId: session?.user?.id
    }
});
console.log('Result:', result);
    </pre>
</body>
</html>