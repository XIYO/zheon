name: Edge Functions Tests

on:
  push:
    paths:
      - '.supabase-remote/functions/**'
      - '.supabase-remote/tests/**'
  pull_request:
    paths:
      - '.supabase-remote/functions/**'
      - '.supabase-remote/tests/**'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x
    
    - name: Cache Deno dependencies
      uses: actions/cache@v3
      with:
        path: ~/.deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/*.ts') }}
        restore-keys: |
          ${{ runner.os }}-deno-
    
    - name: Format check
      run: deno fmt --check .supabase-remote/
    
    - name: Lint
      run: deno lint .supabase-remote/
    
    - name: Type check
      run: |
        cd .supabase-remote/functions
        for dir in */; do
          if [ -f "$dir/index.ts" ]; then
            echo "Type checking $dir"
            deno check "$dir/index.ts"
          fi
        done
    
    - name: Run tests
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        if [ -d ".supabase-remote/tests" ]; then
          deno test --allow-all .supabase-remote/tests/
        fi